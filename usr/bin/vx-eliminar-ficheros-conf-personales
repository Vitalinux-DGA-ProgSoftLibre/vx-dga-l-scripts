#!/bin/bash

<<INFO

# Script encargado de eliminar los archivos de personalización del Entorno de Escritorio
# de cada usuario.  Usado por:

## 1) Post-instalación
## 2) Congelación del Escritorio

# Los archivos son (README de vx-dga-l-default-environment-desktop-settings):

~/.config/openbox/lubuntu-rc.xml
~/.config/lxsession/Lubuntu/desktop.conf
~/.config/pcmanfm/lubuntu/pcmanfm.conf
~/.config/pcmanfm/lubuntu/desktop-items-0.conf
~/.config/lxpanel/Lubuntu/panels/panel
~/.config/lxpanel/default/panels/panel
~/.config/libfm/libfm.conf
~/.config/lxterminal/lxterminal.conf
~/.config/albert

# Se eliminan todos, a excepción del desktop-items-0.conf que crea los elementos virtuales
# del Escritorio: papelera, Documentos, etc.

INFO

ERRORES=0
EJECUTOR="$(whoami)"

# Regeneramos los ficheros de configuración personales de los usuarios:
# 2.1) Si no se pasan parámetros y lo llama el usuario root se regeneran todos los usuarios gráficos
# 2.2) Si no se pasan parámetros y no lo llama el usuario root se regenera los del usuario gráfico actual
# 2.3) Si se le pasan ususarios como parámetros se regeneran únicamente los de esos usuarios
if [[ ! -z "${1}" && "${EJECUTOR}" == "root" ]] ; then
    LISTA_USUARIOS=("${@}")
    elif [[ "${EJECUTOR}" == "root" ]] ; then
    LISTA_USUARIOS=($(vx-usuarios-graficos))
else
    LISTA_USUARIOS=("${EJECUTOR}")
fi

for USUARIO in ${LISTA_USUARIOS[@]} ; do
    # Comprobamos que el usuario existe y cual es su HOME:
    vx-funcs-users vx-check_exit_users "${USU}" && \
    HOMEUSU="$(vx-home-usuario-grafico "${USUARIO}")" || \
    continue
    
    for DIR in ".config/openbox" \
    ".config/lxsession" \
    ".config/pcmanfm" \
    ".config/lxpanel" \
    ".config/libfm" \
    ".config/lxterminal" ; do
        if test -d "${HOMEUSU}/${DIR}" ; then
            if ! rm -Rf "${HOMEUSU}/${DIR}" ; then
                ERRORES=1
                echo "=> ERROR: No se ha podido eliminar ${HOMEUSU}/${DIR} ..."
            else
                echo "=> OK: Se ha eliminado ${HOMEUSU}/${DIR} ..."
            fi
        fi
    done
    
    # Copiamos desde el skel los archivos de configuración que no se autogeneran al iniciar sesión gráfica:
    ## ~/.config/pcmanfm/lubuntu/desktop-items-0.conf
    ## ~/.config/lxpanel/Lubuntu/panels/panel
    ## ~/.config/lxpanel/default/panels/panel
    for DIR in ".config/pcmanfm" \
    ".config/lxpanel" ; do
        # if ! su "${USUARIO}" \
        # -c 'rsync -ahv /etc/skel/'${DIR}' '${HOMEUSU}'/.config' \
        # --login &> /dev/null ; then
        #     ERRORES=1
        #     echo "ERROR: Problema al copiar /etc/skel/${DIR} en ${HOMEUSU} ..."
        # else
        #     echo "OK: copiado /etc/skel/${DIR} en ${HOMEUSU} ..."
        # fi
        if rsync --delete -rl --chown="${USUARIO}" "/etc/skel/${DIR}" "${HOMEUSU}/.config" ; then
            echo "=> OK: copiado /etc/skel/${DIR} en ${HOMEUSU}/.config"
        else
            echo "=> ERROR: Problema al copiar /etc/skel/${DIR} en ${HOMEUSU}/.config"
        fi
    done
    
    # Sincronizamos Albert Launcher:
    if [ -d "/etc/skel/.config/albert" ] ; then
        # if ! su "${USUARIO}" \
        # -c 'rsync -ahv --delete --exclude core.db /etc/skel/.config/albert '${HOMEUSU}'/.config' \
        # --login &> /dev/null ; then
        #     ERRORES=1
        #     echo "ERROR: Problema al copiar Albert en ${HOMEUSU} ..."
        # else
        #     echo "OK: copiado Albert en ${HOMEUSU} ..."
        # fi
        if rsync -ahv --delete --chown="${USUARIO}" --exclude "core.db" "/etc/skel/.config/albert" "${HOMEUSU}/.config" ; then
            echo "OK: copiado /etc/skel/.config/albert en ${HOMEUSU}/.config"
        else
            echo "ERROR: Problema al copiar /etc/skel/.config/albert en ${HOMEUSU}/.config"
        fi
    else
        echo "Warning: No hay configuración de Albert Launcher"
    fi
    
done

#if test "${ERRORES}" -eq 0 ; then
#	exit 0
#else
#	exit 1
#fi
