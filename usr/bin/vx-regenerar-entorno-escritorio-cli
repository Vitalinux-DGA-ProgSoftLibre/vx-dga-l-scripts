#!/bin/bash

#Diseñado por Arturo Martín
#Proyecto Software Libre DGA

EJECUTOR=$(whoami)
LOG="vx-regenerar-entorno-escritorio.log"
USUGRAF="$(vx-usuario-grafico)"
HOMEUSUGRAF="$(vx-home-usuario-grafico "${EJECUTOR}")"

function log_xsession(){
    #
    # Funcion que audita el proceso. Si no se pasa como parámetro el nombre del fichero, dejará un log en /tmp
    # Se auditará en /var/log/vitalinux en el archivo indicado: log_xsession -o nombre_fichero
    #
    while getopts 'o:' OPT; do
        case ${OPT} in
            o) LOGFILE=${OPTARG};;
        esac
    done
    
    if [ "${LOGFILE}" ] ; then
        [ "${EJECUTOR}" == "root" ] && \
        DIRLOG="/var/log/vitalinux" || \
        DIRLOG="${HOMEUSUGRAF}/.vx-logs"
        [ ! -d "${DIRLOG}" ] && mkdir -p "${DIRLOG}"
        LOGFILE="${DIRLOG}/${LOGFILE}"
    else
        LOGFILE="/tmp/logfile.regenerar-entorno-escritorio.log"
    fi
    exec 2>&1
    exec > >(tee -i "${LOGFILE}")
}
# 1) Preparamos la auditoria del servicio:
log_xsession -o "${LOG}"

# Regeneramos el entorno de escritorio de los usuarios:
# 2.1) Si no se pasan parámetros y lo llama el usuario root se regeneran todos los usuarios gráficos
# 2.2) Si no se pasan parámetros y no lo llama el usuario root se regenera la del usuario gráfico actual
# 2.3) Si se le pasan ususarios como parámetros se regeneran únicamente los de esos usuarios
if [[ ! -z "${1}" && "${EJECUTOR}" == "root" ]] ; then
    LISTA_USUARIOS=("${@}")
    elif [[ "${EJECUTOR}" == "root" ]] ; then
    LISTA_USUARIOS=($(vx-usuarios-graficos))
else
    LISTA_USUARIOS=("${EJECUTOR}")
fi

echo "=> $(date) Se va a Regenerar el Entorno de Escritorio de: ${LISTA_USUARIOS[@]}"

# 1) Comenzamos regenerando el contenido del Escritorio
for USUARIO in ${LISTA_USUARIOS[@]} ; do
    # Comprobamos que el usuario existe y cual es su HOME:
    vx-funcs-users vx-check_exit_users "${USU}" && \
    HOMEUSUARIO="$(vx-home-usuario-grafico "${USUARIO}")" || \
    continue
    
    BASE="/etc/skel/Escritorio/"
    if test -d "${BASE}" ; then
        for DIR in "Escritorio" "Desktop" "Bureau" "Schreibtisch" ; do
            if test -d "${HOMEUSUARIO}/${DIR}" ; then
                # if su "${USUARIO}" \
                # -c 'rsync --delete -rl '${BASE}' '${HOMEUSUARIO}'/'${DIR} \
                # --login &> /dev/null ; then
                #     echo " => OK: Se ha sincronizado el ${DIR} del usuario ${USUARIO} ..."
                # else
                #     echo " => ERROR: No se ha sincronizado el ${DIR} del usuario ${USUARIO} ..."
                # fi
                if rsync --delete -rl --chown="${USUARIO}" "${BASE}" "${HOMEUSUARIO}/${DIR}" ; then
                    echo "=> OK: Se ha sincronizado el ${DIR} del usuario: ${USUARIO}"
                else
                    echo "=> ERROR: No se ha sincronizado el ${DIR} del usuario: ${USUARIO}"
                fi
            fi
        done
    fi
    
    # 2) Eliminamos el contenido de los directorios ".cache":
    if [ -d "${HOMEUSUARIO}/.cache" ] ; then
        rm -Rf "${HOMEUSUARIO}/.cache"/* && echo "=> Eliminado: ${HOMEUSUARIO}/.cache/*"
    else
        mkdir -p "${HOMEUSUARIO}/.cache"
    fi
    chown -R "${USUARIO}" "${HOMEUSUARIO}/.cache"
    
    # 3) Seguimos con la regeneración de los archivos de configuración del Entorno de Escritorio
    vx-eliminar-ficheros-conf-personales "${USUARIO}"
    echo -e "\n#### Sincronización Terminada: ${USUARIO} ####\n\n"
done

# 4) Devolvemos el Greeter a su configuración original eliminando las personalizaciones del usuario:
FICHGREETER="/etc/lightdm/lightdm-gtk-greeter.conf"
[ -f "${FICHGREETER}" ] && rm -f "${FICHGREETER}"

# Mensaje de terminación:
echo "=> Terminada regeneración Entornos de Escritorio: ${LISTA_USUARIOS[@]}"
echo "=> Comprobar que todo esta Ok!!"

exit 0