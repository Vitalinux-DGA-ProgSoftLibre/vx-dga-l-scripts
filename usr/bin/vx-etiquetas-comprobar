#!/bin/bash

USER=$(whoami)
if [[ ${USER} = "root" ]] && [[ -f /usr/bin/migasfree-tags ]] ; then
	if ! (
		while ! wget -O /tmp/inet_connection_migasfree migasfree.educa.aragon.es > /dev/null 2>&1 ; do
			echo "#No hay conexión al servidor ..."
			sleep 1
		done
	) | yad --title "Comprobación de Etiquetas Migasfree" \
	--center --width 650 \
	--text-align center \
	--window-icon migasfree \
	--image migasfree \
	--text "  Hay un problema de conexión con el servidor ... \n  <b> Está el equipo conectado a Internet?...</b>\n" \
	--progress  --pulsate --auto-close  --button="Cancelar... Lo Intentaré más tarde":1 ; then
		exit 1
	fi
	if test -f /usr/bin/migasfree-cid ; then
		CID="$(migasfree-cid)"
		NOMBRE="${HOSTNAME}"
	fi
	ETIQUETAS="$(migasfree-tags -g)"
	(
	echo ""
	echo "A continuación se consultarán las Etiquetas Migasfree del Equipo:"
	echo ""
	echo "Nombre del Equipo (hostname): ${NOMBRE}"
	echo "CID del Equipo: ${CID}"
	echo ""
	echo "Etiquetas Migasfree asignadas:"
	echo ""
	echo ${ETIQUETAS} | tr -s " " "\n" | grep -n "-" | sed -e "s/:/) /g" | sed -e "s/.*/  &/g"
	echo ""
	echo "### ---------- TOTAL ETIQUETAS ASIGNADAS: $(echo ${ETIQUETAS} | wc -w) -----------------###"
	) |  yad \
		--title "Etiquetas Migasfree del equipo ${NOMBRE} ${CID}" \
		--window-icon=/usr/share/lxpanel/images/vitalinux.svg \
		--image migasfree \
		--text-info \
		--text "\n Comprobación de las <b>Etiquetas Migasfree</b> asignadas: " \
		--tail \
		--width="700" --height="400" --center \
		--button "Cerrar:0"

else
	yad --title "Migasfree etiquetas" \
		--info --text "No tiene permisos para ejecutar el programa" \
		--window-icon=/usr/share/lxpanel/images/vitalinux.svg \
		--width="400" --height="100" --center \
		--justify="center" --text-align="center" \
		--button "Salir:1"
fi
