#!/bin/bash

USER=$(whoami)

if test $USER = "root" ; then

# Exportamos las variables para saber cual es la IPCache Actual
. /etc/default/vx-dga-variables/vx-dga-variables-general.conf

	TEXTO="\tLa IP actual del servidor Caché es: \"<b>$IPCACHE</b>\" \n\t¿Quieres Modificarla?"

	VALIDO=0
	while test $VALIDO -eq 0 ; do
		RESPUESTA=$(yad --center --width 640 \
		--window-icon vitalinux \
		--image server \
		--title "Modificar IP del Servidor Caché" \
		--text-align center --justify="center" \
		--text "${TEXTO}" \
		--form \
		--field="Dirección IP del Servidor Caché: " "$IPCACHE" \
		--button="Modificar Caché":0 \
		--button="Mantener anterior":1 \
		--buttons-layout center)
		if [[ ! $? -eq 0 ]] ; then
                exit 0
    	fi
		CACHE=$(echo $RESPUESTA | cut -d"|" -f1)
		# Mediante "sipcalc" comprobamos que se trata de una dirección IP
		if ( test -z ${CACHE} ) || \
			sipcalc ${CACHE} | grep "ERR" &> /dev/null ; then
			TEXTO="\n\t¡¡Repasa la IP \"<b>${CACHE}</b>\" Indicada!! \n\tVuelve a introducir la IP del Servidor Caché, por favor ..."
		else
			if yad --center --width 400 \
				--window-icon vitalinux \
				--image server \
				--title "IP del Servidor Caché" \
				--text-align center --justify="center" \
				--text "Por favor confirma la IP Indicada: \n\n $CACHE" \
				--button="Confirmar IP":0 --button="Corregir IP":1 \
				--buttons-layout center ; then
			VALIDO=1
			fi
		fi
	done

	# Antes de hacer el cambio, comprobamos si hay recursos compartidos en /etc/fstab:
	# Matamos el proceso cliente actual
	# * con oknodo para que no de error la postinst 
	# * y con tiempo de espera para que de timepo a finalizar, o sino se pase a mandar una señal de kill)
	/sbin/start-stop-daemon --oknodo --stop --name "nfs-cliente.sh" --retry=TERM/10/KILL/5
	# Desmontamos por si acaso (no será necesario con la version 3.0-18)
	[ -f "/usr/bin/nfs-desmontajes.sh" ] && /usr/bin/nfs-desmontajes.sh

	## Limpiamos el /etc/fstab (lo limpia el script anterior)
	sed --follow-symlinks -i "/^#/d" /etc/fstab
	sed --follow-symlinks -i "/^$/d" /etc/fstab
	sed --follow-symlinks -i "/.*\/nfs\/alumnos.*/d" /etc/fstab
	sed --follow-symlinks -i "/.*\/nfs\/profesor.*/d" /etc/fstab
	sed --follow-symlinks -i "/.*\/nfs\/privado.*/d" /etc/fstab
	sed --follow-symlinks -i "/.*\/nfs\/perfiles.*/d" /etc/fstab

	if test -f /etc/apt/sources.list.d/vx-dga-repos-mirror.list ; then
		sed --follow-symlinks -i "s/${IPCACHE}/${CACHE}/g" /etc/apt/sources.list.d/vx-dga-repos-mirror.list
	fi
	if test -f /etc/default/vx-dga-variables/vx-dga-variables-general.conf ; then
		sed --follow-symlinks -i "s/IPCACHE=.*/IPCACHE=${CACHE}/g" /etc/default/vx-dga-variables/vx-dga-variables-general.conf
	fi

	# Lanzamos el montaje de unidades NFS en el cliente:
	if ! pgrep nfs-cliente &> /dev/null ; then
		echo "--> El servicio de Carpetas Compartidas no esta activo ..."
		echo "--> Se va a iniciar el Servicio de Carpetas Compartidas ..."
		#su -c "/usr/bin/nfs-cliente.sh &" --login root
		/sbin/start-stop-daemon --start --quiet -m --name nfs-cliente.sh --pidfile /run/nfs-cliente.pid -b -a /usr/bin/nfs-cliente.sh
	else
		echo "--> Ya existe un servicio de Carpetas Compartidas Activo ... "
		echo "--> La nueva versión de este servicio actuará a partir del siguiente inicio de sesión ..."
	fi

	if test -f /etc/apt/apt.conf.d/01cache_proxy ; then
		echo -e 'Acquire::http { Proxy "http://'${CACHE}':3142"; };' > /etc/apt/apt.conf.d/01cache_proxy
		echo -e 'Acquire::https { Proxy "false"; };' >> /etc/apt/apt.conf.d/01cache_proxy
	fi


else
		yad --title "Modificar IP del Servidor Caché" \
			--image "server" \
			--info --text "<b>No tiene permiso</b> para ejecutar el programa\n¡¡Debes ser \"<b>root</b>\"" \
			--window-icon vitalinux \
			--width="400" --height="100" --center --justify="center" --timeout=7 --text-align="center"
fi
