#!/bin/bash
USER=$(whoami)

if test $USER = "root"
then

# Exportamos las variables para saber cual es la IPCache Actual
. /etc/default/vx-dga-variables/vx-dga-variables-general.conf

if yad --title "Información IP Caché" \
	--text "  La IP actual del servidor Caché es: <b>$IPCACHE</b>  \n  ¿Quieres Modificarla?" \
	--window-icon=/usr/share/lxpanel/images/vitalinux.svg \
	--image "/usr/share/icons/vitalinux/server-72x72.png" \
	--width="350" --height="100" --justify="center" --center --text-align="center" \
	--button=Continuar:0  --button="No Continuar":1 ; then

	IPCACHENUEVA=$(yad --title "IP Caché" --text "Indica la IP del Servidor Caché:" \
	--window-icon=/usr/share/lxpanel/images/vitalinux.svg \
	--image "/usr/share/icons/vitalinux/server-72x72.png" \
	--justify="center" --center --text-align="center" \
	--form --field="IP " --button=Continuar:0 | cut -d"|" -f1)

	if ping -c 1 $IPCACHENUEVA &> /dev/null ; then
		yad --title "IP Caché" \
		--text "  Ok!! Hay conexión con $IPCACHENUEVA \n  Se va a realizar la modificación ..." \
		--window-icon=/usr/share/lxpanel/images/vitalinux.svg \
		--image "/usr/share/icons/vitalinux/server-72x72.png" \
		--justify="center" --center --text-align="center" \
		--timeout=7 --button=Continuar:0
	else
		if ! yad --title "IP Caché" \
		--text "  ¡¡Problema!! No hay conexión con $IPCACHENUEVA \n  ¿Quieres continuar con el cambio de IP del Servidor?" \
		--window-icon=/usr/share/lxpanel/images/vitalinux.svg \
		--image "/usr/share/icons/vitalinux/server-72x72.png" \
		--justify="center" --center --text-align="center" \
		--button=Continuar:0 --button="No Continuar":1 ; then
			exit 0
		fi
	fi

	## Limpiamos el /etc/fstab de todos los puntos de montaje anteriores y comprobamos si tiene PRIVADO
	if grep ".*:/nfs/.*" /etc/fstab &> /dev/null ; then
		PRIVADO=0
		if grep ".*:/nfs/privado.*" /etc/fstab &> /dev/null ; then
			PRIVADO=1
		fi

		sed -i "/^#/d" /etc/fstab
		sed -i "/^$/d" /etc/fstab
		sed -i "/.*\/nfs\/alumnos.*/d" /etc/fstab
		sed -i "/.*\/nfs\/profesor.*/d" /etc/fstab
		sed -i "/.*\/nfs\/privado.*/d" /etc/fstab
		sed -i "/.*\/nfs\/perfiles.*/d" /etc/fstab
	fi

	## Modificamos el /etc/fstab

	if ps aux | grep nfs-cliente.sh &> /dev/null ;  then
	  killall nfs-cliente.sh
	fi

	if ps aux | grep mount.nfs &> /dev/null ;  then
	  killall mount.nfs
	fi

	if ! grep "^$IPCACHENUEVA:/nfs/" /etc/fstab &> /dev/null ; then
	# Añadimos en el fstab los puntos de montaje para alumnos, profesores y perfiles
		echo -e "$IPCACHENUEVA:/nfs/profesor /media/profesores nfs \
actimeo=1800,noatime,nolock,bg,nfsvers=3,tcp,rw,noauto,user,hard,intr,defaults,exec 0 0\n\
$IPCACHENUEVA:/nfs/alumnos /media/alumnos nfs \
actimeo=1800,noatime,nolock,bg,nfsvers=3,tcp,rw,noauto,user,hard,intr,defaults,exec 0 0\n\
$IPCACHENUEVA:/nfs/perfiles /perfiles nfs \
actimeo=1800,noatime,nolock,bg,nfsvers=3,tcp,rw,noauto,user,hard,intr,defaults,exec 0 0" >> /etc/fstab
	fi

	if test $PRIVADO -eq 1 ; then
	# Añadimos en el fstab el punto de montaje privado
		echo "$IPCACHENUEVA:/nfs/privado /media/privado nfs \
actimeo=1800,noatime,nolock,bg,nfsvers=3,tcp,rw,noauto,user,hard,intr,defaults,exec 0 0" >> /etc/fstab
	fi

if test -f /etc/apt/apt.conf.d/01cache_proxy ; then
	echo -e 'Acquire::http { Proxy "http://'$IPCACHENUEVA'"; };' > /etc/apt/apt.conf.d/01cache_proxy
	echo -e 'Acquire::https { Proxy "false"; };' >> /etc/apt/apt.conf.d/01cache_proxy
fi

	if sed -i "s/^IPCACHE.*/IPCACHE=$IPCACHENUEVA/g" /etc/default/vx-dga-variables/vx-dga-variables-general.conf ;  then
	# Modificamos el valor de IPCACHE en el archivo de variables
			yad --title "Completado" \
			--image "/usr/share/icons/vitalinux/server-72x72.png" \
			--text "Se ha modificado la IP del Caché a <b>$IPCACHENUEVA</b> con exito" \
			--center \
			--window-icon=/usr/share/lxpanel/images/vitalinux.svg \
			--width="350" --height="100" --timeout=7 --text-align="center"
	else
			yad --title "Problemas ..." --info \
			--image "/usr/share/icons/vitalinux/server-72x72.png" \
			--text " Se ha producido algún problema al cambiar la IP del Caché ... " \
			--window-icon=/usr/share/lxpanel/images/vitalinux.svg \
			--center --width="350" --height="100" --timeout=7 --text-align="center"
	fi
else
		yad --title "Cambiar IP Caché" \
			--image "/usr/share/icons/vitalinux/server-72x72.png" \
			--info --text "No tiene permiso para ejecutar el programa" \
			--window-icon=/usr/share/lxpanel/images/vitalinux.svg \
			--width="400" --height="100" --center --justify="center" --timeout=7 --text-align="center"
fi
fi
