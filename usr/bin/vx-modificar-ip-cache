#!/bin/bash

mod_ip_cache(){
  # modificar_ip_cache old_IP new_IP
  [[ "$1" = "$2" ]] && return 0
  # Modificamos la IP del Caché en el documento de variables:
  FILEVAR="/etc/default/vx-dga-variables/vx-dga-variables-general.conf"

  # Como vamos a modificar la ip del caché, debemos reiniciar el servicio de carpetas compartidos si está lanzado
  /sbin/start-stop-daemon --status --name nfs-cliente.sh && /sbin/start-stop-daemon --oknodo --stop --name nfs-cliente.sh --retry=TERM/5/KILL/2
  if [[ -f $FILEVAR ]]; then
    sed -i "s#^IPCACHE=.*#IPCACHE=${2}#g" $FILEVAR
  fi
  /sbin/start-stop-daemon --start --quiet -m --name nfs-cliente.sh --pidfile /run/nfs-cliente.pid -b -a /usr/bin/nfs-cliente.sh

  # Modificamos la configuración del proxy apt
  local proxy_file="/etc/apt/apt.conf.d/01cache_proxy"
  #Comprobamos lo primero si el servidor caché está en la red
  if ping -c 1 "${2}" > /dev/null 2>&1 && nc -zv "${2}" 3142 > /dev/null 2>&1 ; then
    # Servidor Cache que ofrece servicio APT-CACHER"
    echo "Acquire::http { Proxy \"http://${2}:3142\"; };" > $proxy_file
    echo 'Acquire::https { Proxy "false"; };' >> $proxy_file
  else  
    # Borrar el posible archivo generado anteriormente del proxy-cache
    [[ -f $proxy_file ]] && rm -f $proxy_file
  fi
  # Actualizamos el nombre del servidor cache en el hosts
  local hosts_file="/etc/hosts"
  [ ! -f $hosts_file ] && echo "Error, no hay archivo hosts en éste equipo..." && return 1
  if grep "servidor.vitalinux" $hosts_file &> /dev/null ; then
    sed -i "s/.*servidor.vitalinux.*/${2} servidor.vitalinux/g" $hosts_file
  else
  	echo "${2} servidor.vitalinux" >> $hosts_file
  fi
  if grep "servidor.vx" $hosts_file &> /dev/null ; then
  	sed -i "s/.*servidor.vx.*/${2} servidor.vx/g" $hosts_file
  else
  	echo "${2} servidor.vx" >> $hosts_file
  fi
}

USER=$(whoami)

if test $USER = "root" ; then

# Exportamos las variables para saber cual es la IPCache Actual
. /etc/default/vx-dga-variables/vx-dga-variables-general.conf

	TEXTO="\tLa IP actual del servidor Caché es: \"<b>$IPCACHE</b>\" \n\t¿Quieres Modificarla?"

	VALIDO=0
	while test $VALIDO -eq 0 ; do
		RESPUESTA=$(yad --center --width 640 \
		--window-icon vitalinux \
		--image server \
		--title "Modificar IP del Servidor Caché" \
		--text-align center --justify="center" \
		--text "${TEXTO}" \
		--form \
		--field="Dirección IP del Servidor Caché: " "$IPCACHE" \
		--button="Modificar Caché":0 \
		--button="Mantener anterior":1 \
		--buttons-layout center)
		if [[ ! $? -eq 0 ]] ; then
                exit 0
    	fi
		CACHE=$(echo $RESPUESTA | cut -d"|" -f1)
		# Mediante "sipcalc" comprobamos que se trata de una dirección IP
		if ( test -z ${CACHE} ) || \
			sipcalc ${CACHE} | grep "ERR" &> /dev/null ; then
			TEXTO="\n\t¡¡Repasa la IP \"<b>${CACHE}</b>\" Indicada!! \n\tVuelve a introducir la IP del Servidor Caché, por favor ..."
		else
			if yad --center --width 400 \
				--window-icon vitalinux \
				--image server \
				--title "IP del Servidor Caché" \
				--text-align center --justify="center" \
				--text "Por favor confirma la IP Indicada: \n\n $CACHE" \
				--button="Confirmar IP":0 --button="Corregir IP":1 \
				--buttons-layout center ; then
			VALIDO=1
			fi
		fi
	done

	mod_ip_cache "${IPCACHE}" "${CACHE}"

else
		yad --title "Modificar IP del Servidor Caché" \
			--image "server" \
			--info --text "<b>No tiene permiso</b> para ejecutar el programa\n¡¡Debes ser \"<b>root</b>\"" \
			--window-icon vitalinux \
			--width="400" --height="100" --center --justify="center" --timeout=7 --text-align="center"
fi
