#!/bin/bash
. /etc/default/vx-dga-variables/vx-dga-variables-general.conf
MIGASFREE="migasfree.educa.aragon.es"
USER=$(whoami)
PDI=""
ARCHSO=$(getconf LONG_BIT)

function close_yad(){
    kill -s SIGUSR1 "$YAD_PID"
}
export -f close_yad

function log_xsession(){
#
# Funcion que loguea el proceso. Si no se pasa como parámetro el nombre del fichero, dejará un log en /tmp
# Si se quiere loguera en /var/log/vitalinux se llamará como log_xsession -o nombre_fichero
# 
	while getopts 'o:' OPT; do
        case $OPT in
            o) LOGFILE=$OPTARG;;
        esac
	done

	if [ "$LOGFILE" ] ; then
		if [ ! -d /var/log/vitalinux ]; then
			mkdir -p /var/log/vitalinux
		fi
		LOGFILE="/var/log/vitalinux/$LOGFILE"
	else
		LOGFILE="/tmp/logfile"
	fi
	export fpipe=$(mktemp -u --tmpdir yadlog.XXXXXXXX)
	mkfifo "$fpipe"
	exec 3<> "$fpipe"
	exec 2>&1
	exec > >(tee -i "$fpipe" >> "$LOGFILE" )
	# Borramos la pipe cuando salgamos
	trap "rm -f $fpipe" EXIT
	yad --title "Ventana de Log" --text-info --tail \
			--window-icon vitalinux \
			--center --width="720" --height="520" \
			--no-escape --no-focus --tail --button="Ocultar:bash -c close_yad" < "$fpipe" &

	YAD_LOG=$!
	export YAD_LOG
}

function close_exit(){
	echo "Se cancela el proceso por parte del usuario antes de tiempo"
    if [ -n "$YAD_LOG" ] && ps -p "$YAD_LOG" > /dev/null; then 
    	kill -s SIGUSR1 "$YAD_LOG"
    fi
    if [ -n "$YAD_PID" ] && ps -p "$YAD_PID" > /dev/null; then 
    	 kill -s SIGUSR1 "$YAD_PID"
    fi
    # Salimos del programa
    exit 1

}
export -f close_exit


function seleccionar-modelo-pdi {

	PDI=$(yad --center --width 300 --title "Seleccionar PDI" \
		--window-icon vitalinux \
		--image pdi \
		--button="Continuar":0 --button="Canelar":1 \
		--entry \
		--text "Selecciona tu PDI:" \
		--entry-text \
		"No driver" "eBeam" "Hitachi" "Interwrite" "IQBoard" "Multiclass" "Promethean" "Smartboard")
}

function comprobar-md5 {
	ARCHIVO=$1
	cd /opt/pkgs/pdis
	echo ""
	if test -f ./"${ARCHIVO}" -a -f ./"${ARCHIVO}".md5 ; then
		echo "Ya están descargados los archivos ${ARCHIVO} y ${ARCHIVO}.md5 ..."
		echo "----------------------------"
		md5sum "${ARCHIVO}"
		cat ./"${ARCHIVO}".md5
		if test "$(md5sum ${ARCHIVO})" == "$(cat ./${ARCHIVO}.md5)" ; then
			echo "--> Ok!! Coinciden el MD5 de ${ARCHIVO} con ${ARCHIVO}.md5 ..."
			echo "----------------------------"
	        echo ""
			return 0
		else
			echo "--> Error!! No coinciden el MD5 de ${ARCHIVO} con ${ARCHIVO}.md5 ..."
			echo "--> Se va a intentar volver a descargar los archivos ..."
			echo "----------------------------"
	        echo ""
			rm -Rf ./${ARCHIVO}* &> /dev/null
			return 1
		fi
	else
		echo "--> El archivo ${ARCHIVO} o su MD5 no existen.  Se descargarán de nuevo ..."
		rm -Rf ./${ARCHIVO}* &> /dev/null
		return 1
	fi
}

function descargar-archivos {
	YADBARS=""
	CONTADOR=1
	for ruta in $@ ; do
		# Obtenemos el nombre del archivo a descargar de la URL proporcionada
	  NOMBREARCHIVO=$(echo "$ruta" | awk -F "/" {'print $NF'})
	  YADBARS="$YADBARS --bar=Descargando->$NOMBREARCHIVO:NORM"
	  CONTADOR=$((CONTADOR + 1))
	done

	(
	CONTADOR=1
	for ruta in $@ ; do
		NOMBREARCHIVO=$(echo "$ruta" | awk -F "/" {'print $NF'})
		# Para cada barra de progreso: El primer parametro es la barra de progreso afectada y el segundo el texto que mostrará
		wget "$ruta" 2>&1 | sed -u \
		"s/.* \([0-9]\+%\)\ \+\([0-9,.]\+.\) \(.*\)/$CONTADOR:\1\n$CONTADOR:# Descargando a \2\/s, T. Restante: \3/"
		# Obtenemos el resultado de la descarga proporcionado por wget
		RET_WGET="${PIPESTATUS[0]}"
		if [[ "$RET_WGET" = 0 ]] ; then
			echo "$CONTADOR:100%"
			echo "$CONTADOR:#Descarga de $NOMBREARCHIVO Completada ..."
		else
			echo "$CONTADOR:#Error en la Descarga de $NOMBREARCHIVO ..."
		fi
		CONTADOR=$((CONTADOR + 1))
	done
	) | yad --center --width 700 \
		--title "Descarga de Drivers PDIs" \
		--window-icon vitalinux \
		--justify="center" --text-align="center" \
		--text "  Descargando el Software necesario ... <b>¡¡paciencia!!</b> ... \n  Puede tardar <b>Varios Minutos</b>  \n   Modelo PDI: <b>$PDI</b>   " \
		--multi-progress \
		$YADBARS \
		--auto-close --button="Cancelar":1
	##
	## Si el usuario cancela la descarga o bien hay un error (no hay red por ejemplo)
	if [ "$?" = "1" ] ; then
		if yad --center --title "Drivers PDIs" --question \
		--window-icon vitalinux \
		--image pdi \
		--text "   Hubo un problema a la hora de descargar el software o ha sido cancelada la operación por el usuario...deseas reintentar la descarga?   " \
		--width="350" --center \
		--justify="center" --text-align="center" \
		--button="Continuar":0 --button="Cancelar":1 ;  then
			
			descargar-archivos $@
			return $?
		else
			
			return 1
		fi 
	fi
	return 0

}

function comprobar-archivos {
	LISTADESCARGAS=""
	for RUTA in $@ ; do
		ARCHIVO=$(echo "$RUTA" | awk -F "/" {'print $NF'})
		if ! comprobar-md5 $ARCHIVO ; then
			echo "--> El archivo $ARCHIVO NO se encentra de manera integra en /opt/pkgs/pdis ..."
			echo "--> ... por lo tanto, $ARCHIVO se descargará a continuación ..."
			if ping -c 1 "$IPCACHE" &> /dev/null && wget --spider -q "http://${IPCACHE}${RUTA}" ; then
				LISTADESCARGAS="$LISTADESCARGAS http://${IPCACHE}${RUTA} http://${IPCACHE}${RUTA}.md5"
			else
				LISTADESCARGAS="$LISTADESCARGAS http://${MIGASFREE}${RUTA} http://${MIGASFREE}${RUTA}.md5"
			fi
		else
			echo "--> El archivo $ARCHIVO ya existe de manera integra en /opt/pkgs/pdis ..."
			echo "--> ... por lo tanto, $ARCHIVO no se descargará de nuevo ..."
		fi
	done
	if test "$LISTADESCARGAS" = "" ; then
		return 0
	else
		descargar-archivos "$LISTADESCARGAS"
	fi
}

# Los archivos a descargar y posteriormente a instalar no se pueden pasar por parámetro ya que luego es importante el orden o acciones posteriores...
function descargar-software-pdi {

	if ! test -d /opt/pkgs/pdis ; then
		mkdir -p /opt/pkgs/pdis
	fi
	cd /opt/pkgs/pdis

	case $PDI in

		"eBeam")
		if [ "$ARCHSO" = "64" ] ; then
			yad --title "Instalación de Software de la PDI $PDI" \
				--text " Lo sentimos pero de momento eBeam NO facilita controladores para 64 bits "\
				--window-icon vitalinux \
				--image pdi \
				--width="400" --height="100" \
				--center --justify="center" --text-align="center" --button="gtk-ok":0
			return 1
		fi
		FILESPDI="/pdis/eBeam/scrapbook-selfextracting"
		;;

		"Hitachi") 
		
		FILESPDI="/pdis/HITACHI/StarBoardSoftware_9.62_i586.deb"
		;;

		"Interwrite")
		FILESPDI="/pdis/Interwrite/WorkSpace_Ubuntu_6.3.0.97"
		;;

		"IQBoard")
		if [ "$ARCHSO" = "64" ] ; then
		  FILESPDI="/pdis/IQBoard/IQBoard_64/iqboard.deb /pdis/IQBoard/IQBoard_64/rsboardep.deb"
		else
		  FILESPDI="/pdis/IQBoard/IQBoard_32/iqboard.deb /pdis/IQBoard/IQBoard_32/rsboardep.deb"
		fi
		;;

		"Multiclass")
		FILESPDI="/pdis/multiCLASS/multiCLASSBoard.tar.gz"
		;;

		"Promethean")
		if [ "$ARCHSO" = "64" ] ; then
		  FILESPDI="/pdis/Promethean/promethean_64/activaid_5.14.21-0.deb \
		  	/pdis/Promethean/promethean_64/activdriver_5.14.21-0.deb \
		  	/pdis/Promethean/promethean_64/activtools_5.14.21-0.deb"
		else
		  FILESPDI="/pdis/Promethean/promethean_32/activaid_5.14.21-0.deb \
		  	/pdis/Promethean/promethean_32/activdriver_5.14.21-0.deb \
		  	/pdis/Promethean/promethean_32/activinspire_2.4.66096-1.i386_i386.deb \
		  	/pdis/Promethean/promethean_32/activtools_5.14.21-0.deb"
		fi
		;;

		"Smartboard")
		FILESPDI="/pdis/SmartBoard/smart-hwr_11.3.2087.1-1_i386.deb"
		;;

	esac
	comprobar-archivos "$FILESPDI"
}


function instalar-software-pdi {

	cd /opt/pkgs/pdis
	case $PDI in

	"eBeam")
	if test -f ./scrapbook-selfextracting ; then
		chmod +x /opt/pkgs/pdis/scrapbook-selfextracting
		/opt/pkgs/pdis/scrapbook-selfextracting
	fi
	;;

	"Hitachi")
	if test -f ./StarBoardSoftware_9.62_i586.deb ; then
		if ! dpkg -l | grep -e "starboardsoftware[ ]*9.62" >/dev/null 2>/dev/null ; then
			dpkg -i /opt/pkgs/pdis/StarBoardSoftware_9.62_i586.deb
		else
			echo "El software para esta PDI esta actualizado a la ultima version...se omite su instalacion"
		fi
		/usr/local/StarBoardSoftware/install.sh
		apt-get -f --assume-yes --force-yes install
		# Instalamos los drivers necesarios
		# 1. El primero es para que el servicio que el demonio que se encarga de hablar con la pizarra (driver) DGBoard se pueda ejecutar en 64 bits
		apt-get --assume-yes --force-yes install libusb-0.1-4:i386
		# 2. lsadrv es el módulo del kernel que necesitan las FX77 Trio para funcionar. Aportado por la comunidad (no por HITACHI). Para las DUO no es neceario
		# pero tampoco molesta que se cargue en memoria
		apt-get --assume-yes --force-yes install vx-dga-l-lsadrv-hitachi
		# Modificamos el lanzador de calibrado que no se ejecuta correctamente desde entorno grafico
		if [ -f /usr/share/applications/hitachi-starboard-calibrate.desktop ] ; then
			sed -i 's/^Terminal=[Tt]rue/Terminal=false/g' /usr/share/applications/hitachi-starboard-calibrate.desktop
		fi

	fi
	;;

	"Interwrite")
	if test -f ./WorkSpace_Ubuntu_6.3.0.97 ; then
		chmod +x /opt/pkgs/pdis/WorkSpace_Ubuntu_6.3.0.97
		/opt/pkgs/pdis/WorkSpace_Ubuntu_6.3.0.97

	fi
	;;

	"IQBoard")
	# Cosultar en /var/lib/dpkg/info/iqboard.deb.postinst que hay acciones que no se pueden realizar
	if test -f ./iqboard.deb -a -f ./rsboardep.deb ; then
		# Borramos cualquier instalacion previa de drivers o software
		if dpkg -l | grep iqboard.deb >/dev/null 2>/dev/null ; then
			echo "Borrando software instalado..."
			dpkg -P iqboard.deb
		fi
		if dpkg -l | grep rsboard >/dev/null 2>/dev/null ; then
			echo "Borrando driver instalado..."
			dpkg -P rsboardep
		fi
		dpkg -i /opt/pkgs/pdis/rsboardep.deb
		dpkg -i /opt/pkgs/pdis/iqboard.deb
		if test -f /usr/share/gnome/autostart/RSBoardEPStart.desktop ; then
		  cp /usr/share/gnome/autostart/RSBoardEPStart.desktop /etc/xdg/autostart/
		fi

	fi
	;;

	"Multiclass")
	if test -f ./multiCLASSBoard.tar.gz ; then
		tar -xzvf /opt/pkgs/pdis/multiCLASSBoard.tar.gz
		cd /opt/pkgs/pdis/multiCLASSBoard/setup
		chmod +x ./setup.sh
		./setup.sh
		cd /opt/pkgs/pdis
	fi
	;;

	"Promethean")
	if [ "$ARCHSO" = "64" ] ; then
		#apt-get install dkms libssl0.9.8 gamin libgamin0 libxdo3 xdotool libxcb-xinerama0
		dpkg -i /opt/pkgs/pdis/activaid_5.14.21-0.deb
		dpkg -i /opt/pkgs/pdis/activdriver_5.14.21-0.deb
		dpkg -i /opt/pkgs/pdis/activtools_5.14.21-0.deb
		apt-get -f --assume-yes --force-yes install

	else
		#apt-get install dkms libssl0.9.8 gamin libgamin0 libxdo3 xdotool libxcb-xinerama0
		dpkg -i /opt/pkgs/pdis/activaid_5.14.21-0.deb
		dpkg -i /opt/pkgs/pdis/activdriver_5.14.21-0.deb
		dpkg -i /opt/pkgs/pdis/activtools_5.14.21-0.deb
		dpkg -i /opt/pkgs/pdis/activinspire_2.4.66096-1.i386_i386.deb
		apt-get -f --assume-yes --force-yes install
	fi
	;;

	"Smartboard")
	if test -f ./smart-hwr_11.3.2087.1-1_i386.deb ; then
		dpkg -i /opt/pkgs/pdis/smart-hwr_11.3.2087.1-1_i386.deb
		apt-get -f --assume-yes --force-yes install
	fi
	;;

	esac

	# Por último instalamos el open-boad/open-sankore
	if yad --center --title "Drivers PDIs" --question \
		--window-icon vitalinux \
		--image pdi \
		--text "   Deseas (se recomienda) instalar <b>Open-Board(64bits recomendado)/Open-Sankore</b>   " \
		--width="350" --center \
		--justify="center" --text-align="center" \
		--button="Continuar":0 --button="Cancelar":1 ;  then

		cd /opt/pkgs/pdis

		# Descargamos el Open-Sankore
		if [ "$ARCHSO" = "64" ] ; then
			comprobar-archivos "/pdis/openboard_ubuntu_14.04_1.3.4_amd64.deb"
			dpkg -i /opt/pkgs/pdis/openboard_ubuntu_14.04_1.3.4_amd64.deb
			apt-get -f --assume-yes --force-yes install
		else
			comprobar-archivos "/pdis/Open-Sankore_2.5.1_i386.deb"
			dpkg -i /opt/pkgs/pdis/Open-Sankore_2.5.1_i386.deb
			apt-get -f --assume-yes --force-yes install
		fi

	fi

}

if test "$USER" != "root" ; then
	yad --title "Instalación del Software de PDIs" \
			--center --justify="center" --text-align="center" \
			--width="400" --height="100" \
			--window-icon vitalinux \
			--text "No tiene permiso para ejecutar el programa" \
			--button="Continuar":1
	exit 1
fi

log_xsession -o drivers-pdis

yad --center --title "Drivers PDIs" --question \
	--window-icon vitalinux \
	--image pdi \
	--on-top \
	--text "   ¿Desea continuar con la Instalación de <b>Drivers para las PDIs</b>?   \n   Para no demorar la instalación es aconsejable contar con un servidor caché, pero es posible realizar la descarga directamente desde Internet   " \
	--width="350" --height="50" --center \
	--justify="center" --text-align="center" \
	--button="gtk-ok":0 \
	--button="Salir":1
if [ "$?" != "0" ]; then
	close_exit
fi

seleccionar-modelo-pdi && descargar-software-pdi && instalar-software-pdi


yad --title "Instalación de Software de la PDI $PDI" \
	 --text "   Ya se han realizado todas las tareas solicitadas   \n   Si no ha detectado errores debería estar todo configurado... "\
	--window-icon vitalinux \
	--image pdi \
	--width="400" --height="100" \
	--center --justify="center" --text-align="center" --button="gtk-ok":0
 if [ -n "$YAD_LOG" ] && ps -p "$YAD_LOG" > /dev/null; then 
    	kill -s SIGUSR1 "$YAD_LOG"
 fi
 exit 0
